# 👑 管理员配置指南

## 🎯 快速配置步骤

### 步骤1: 部署合约并记录管理员地址

```bash
cd contracts
npx hardhat run scripts/deploy.ts --network ganache
```

**查看输出信息**，找到这一行：
```
管理员地址（公证人）: 0xABC...XYZ
```

**复制这个地址**，这是您的管理员地址！

### 步骤2: 自动更新前端配置

```bash
node scripts/update-frontend-config.js
```

这个脚本会自动将管理员地址写入前端配置文件。

### 步骤3: 验证配置

打开 `frontend/src/contracts/addresses.ts`，应该看到：

```typescript
// 部署后自动生成的合约地址
export const CONTRACT_ADDRESSES = {
  BetToken: "0x...",
  BetTicket: "0x...",
  BettingSystem: "0x..."
};

// 管理员地址（公证人）
export const ADMIN_ADDRESS = "0xABC...XYZ";  // ← 这里应该是实际地址
```

### 步骤4: 在MetaMask中导入管理员账户

1. 打开MetaMask
2. 点击账户图标 → "导入账户"
3. 在Ganache中找到对应地址的私钥
4. 粘贴私钥并导入

### 步骤5: 启动前端并测试

```bash
cd frontend
npm start
```

## ✅ 如何验证您是管理员

### 视觉标识

当使用管理员账户登录时，您会看到：

1. **顶部金色徽章**
   ```
   🎰 去中心化彩票系统
   👑 管理员（公证人）  ← 金色闪动的徽章
   ```

2. **创建项目标签**
   ```
   [📋 所有项目] [➕ 创建项目] [🎫 我的彩票] [🛒 交易市场]
                  ↑ 只有管理员能看到
   ```

3. **创建页面的提醒**
   ```
   ➕ 创建竞猜项目
   [👑 您正在以管理员身份创建竞猜项目]
   ```

### 功能差异

| 功能 | 普通用户 | 管理员 |
|------|---------|--------|
| 查看项目 | ✅ | ✅ |
| 购买彩票 | ✅ | ✅ |
| 交易彩票 | ✅ | ✅ |
| **创建项目** | ❌ | ✅ |
| **结算项目** | ❌ | ✅（仅自己创建的） |
| 领取代币 | ✅ | ✅ |

## 🔧 手动配置（高级）

如果自动配置失败，可以手动设置：

### 方法1: 修改配置文件

编辑 `frontend/src/contracts/addresses.ts`：

```typescript
export const ADMIN_ADDRESS = "0x您从Ganache复制的地址";
```

**重要**：地址必须完全匹配（但不区分大小写）

### 方法2: 使用环境变量（可选）

在 `frontend/.env` 中添加：

```
REACT_APP_ADMIN_ADDRESS=0x您的管理员地址
```

然后在 `addresses.ts` 中：

```typescript
export const ADMIN_ADDRESS = process.env.REACT_APP_ADMIN_ADDRESS || "0xdefault";
```

## 🎭 多管理员支持（扩展）

如果需要多个管理员，可以修改 `App.tsx`：

```typescript
// 定义管理员列表
const ADMIN_ADDRESSES = [
  "0x第一个管理员地址",
  "0x第二个管理员地址",
  "0x第三个管理员地址"
].map(addr => addr.toLowerCase());

// 修改判断逻辑
const isAdmin = ADMIN_ADDRESSES.includes(account.toLowerCase());
```

## 🔍 故障排查

### 问题1: 看不到管理员徽章

**检查清单**：
- [ ] 确认已运行 `update-frontend-config.js`
- [ ] 打开 `addresses.ts` 确认 `ADMIN_ADDRESS` 不是 "0xYOUR..."
- [ ] 检查MetaMask中的账户地址是否与配置匹配
- [ ] 刷新浏览器页面（Ctrl+F5 强制刷新）
- [ ] 检查浏览器控制台是否有错误

**调试方法**：

在浏览器控制台输入：
```javascript
console.log("当前账户:", window.ethereum.selectedAddress);
console.log("管理员地址:", "从addresses.ts复制的地址");
console.log("是否匹配:", window.ethereum.selectedAddress.toLowerCase() === "管理员地址".toLowerCase());
```

### 问题2: 配置文件未更新

手动运行：
```bash
cd contracts
node scripts/update-frontend-config.js
```

如果报错"找不到文件"，检查：
- [ ] `contract-addresses.json` 是否存在于 `contracts/` 目录
- [ ] 是否已成功部署合约

### 问题3: 两个账户都显示管理员

**原因**：配置了错误的地址

**解决**：
1. 运行 `npx hardhat run scripts/deploy.ts --network ganache` 
2. 记录输出的管理员地址
3. 手动编辑 `frontend/src/contracts/addresses.ts`
4. 重启前端

## 📋 完整检查流程

```bash
# 1. 确保在项目根目录
pwd  # 应该显示 .../ZJU-blockchain-course-2025

# 2. 部署合约
cd contracts
npx hardhat run scripts/deploy.ts --network ganache
# ← 记录输出的管理员地址

# 3. 更新前端配置
node scripts/update-frontend-config.js

# 4. 检查配置文件
cat ../frontend/src/contracts/addresses.ts
# ← 确认 ADMIN_ADDRESS 是正确的

# 5. 启动前端
cd ../frontend
npm start

# 6. 在浏览器中测试
# - 打开 http://localhost:3000
# - 连接管理员账户
# - 应该看到金色徽章和创建项目按钮
```

## 🎯 最佳实践

1. **使用第一个Ganache账户作为管理员**
   - 地址固定，易于识别
   - 默认有最多的ETH

2. **保存管理员私钥**
   - 在安全的地方记录
   - 测试环境可以写在文档中

3. **测试用其他账户**
   - 至少导入3个Ganache账户到MetaMask
   - 一个做管理员，其他做普通用户
   - 便于测试彩票交易功能

4. **重新部署时记得更新配置**
   ```bash
   npx hardhat run scripts/deploy.ts --network ganache
   node scripts/update-frontend-config.js
   # 重启前端
   ```

## 🔐 安全提示

⚠️ **注意**：当前实现只在前端限制了创建项目按钮的显示

如果需要在合约层面限制，需要修改 `BettingSystem.sol`：

```solidity
address public admin;

constructor(...) {
    admin = msg.sender;
}

function createProject(...) external {
    require(msg.sender == admin, "Only admin can create projects");
    // ... 其余代码
}
```

但对于作业演示，前端限制已经足够！

## ✅ 验收检查

使用以下清单验证配置成功：

**管理员账户登录时**：
- [ ] 看到金色👑徽章
- [ ] 看到"➕ 创建项目"标签
- [ ] 可以进入创建页面
- [ ] 看到"👑 您正在以管理员身份创建竞猜项目"提示
- [ ] 可以创建新项目
- [ ] 在项目列表中看到"我创建的"标签
- [ ] 可以结算自己创建的项目

**普通账户登录时**：
- [ ] 没有金色徽章
- [ ] 没有"创建项目"标签
- [ ] 无法看到结算按钮（除非项目不是自己创建的）
- [ ] 可以正常购买、交易彩票

---

配置完成后，您就可以完整体验管理员功能了！🎉

