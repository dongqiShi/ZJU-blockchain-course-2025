# 去中心化彩票系统 - 完整使用说明文档

## 📋 项目简介

这是一个功能完整的去中心化彩票系统，支持竞猜项目创建、彩票购买、彩票交易和奖励结算等功能。

### 主要功能
- ✅ **ERC20 积分系统**: 用户可以领取 BET 代币用于购买彩票
- ✅ **ERC721 彩票凭证**: 每张彩票都是一个唯一的 NFT
- ✅ **创建竞猜项目**: 公证人可以创建多选项竞猜项目并设置基础奖金
- ✅ **购买彩票**: 玩家可以选择任意选项购买彩票
- ✅ **彩票交易**: 玩家之间可以自由交易彩票
- ✅ **链上订单簿**: 显示所有挂单，支持最优价格购买
- ✅ **项目结算**: 公证人可以设置获胜选项
- ✅ **奖励领取**: 获胜者平分奖池

---

## 🚀 快速开始

### 环境要求
- Node.js (v16 或更高版本)
- Ganache (本地以太坊测试网络)
- MetaMask 浏览器插件 (Edge/Chrome/Firefox)

### 1. 启动 Ganache

打开 Ganache 应用程序，创建一个新的工作区或使用快速启动。

**重要配置**：
- RPC 服务器地址: `http://127.0.0.1:8545`
- 网络 ID: `1337` (默认)
- 确保至少有一个账户有足够的 ETH

### 2. 配置 Ganache 账户

1. 在 Ganache 中，复制第一个账户的私钥
2. 打开 `contracts/hardhat.config.ts`
3. 将私钥替换到配置文件中的 `accounts` 数组：

```typescript
accounts: [
  '你的Ganache私钥'
]
```

### 3. 安装依赖并部署合约

在项目根目录打开 PowerShell 或命令行：

```bash
# 进入合约目录
cd contracts

# 安装依赖
npm install

# 编译合约
npx hardhat compile

# 部署合约到 Ganache
npx hardhat run scripts/deploy.ts --network ganache

# 更新前端配置（将合约地址同步到前端）
node scripts/update-frontend-config.js
```

**预期输出**：
```
开始部署合约...
部署账户: 0x...
1. 部署 BetToken...
BetToken 部署地址: 0x...
2. 部署 BetTicket...
BetTicket 部署地址: 0x...
3. 部署 BettingSystem...
BettingSystem 部署地址: 0x...
4. 转移 BetTicket 所有权给 BettingSystem...
所有权转移成功
```

### 4. 配置 MetaMask

#### 添加 Ganache 网络

1. 打开 MetaMask
2. 点击顶部的网络下拉菜单
3. 选择"添加网络" → "手动添加网络"
4. 填写以下信息：
   - **网络名称**: Ganache Local
   - **RPC URL**: http://127.0.0.1:8545
   - **链 ID**: 1337
   - **货币符号**: ETH
5. 点击"保存"

#### 导入 Ganache 账户

1. 在 MetaMask 中点击右上角的账户图标
2. 选择"导入账户"
3. 粘贴 Ganache 中某个账户的私钥
4. 点击"导入"
5. **建议导入至少 2-3 个账户**以便测试交易功能

### 5. 启动前端应用

在项目根目录打开新的 PowerShell 窗口：

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm start
```

前端应用将在浏览器中自动打开: `http://localhost:3000`

---

## 📖 详细使用教程

### 第一步：连接钱包

1. 打开前端页面
2. 点击右上角的"连接钱包"按钮
3. MetaMask 会弹出，选择要连接的账户
4. 点击"下一步"和"连接"

**成功标志**: 页面右上角显示账户地址和 BET 代币余额

### 第二步：领取 BET 代币

1. 连接钱包后，如果有可领取次数，会显示"领取代币"按钮
2. 点击"领取代币"
3. MetaMask 会弹出确认交易的窗口，点击"确认"
4. 等待交易确认

**结果**: 
- 每次领取获得 1000 BET 代币
- 每个地址最多可领取 10 次
- 余额会自动更新

### 第三步：创建竞猜项目（公证人操作）

1. 点击"创建项目"标签页
2. 填写项目信息：
   - **项目名称**: 例如 "NBA 2024赛季 MVP"
   - **项目描述**: 详细说明竞猜规则
   - **选项**: 用逗号分隔，例如 "詹姆斯,库里,杜兰特,字母哥"
   - **持续时间**: 单位为秒，例如 86400（1天）
   - **基础奖金**: 您愿意投入的 BET 代币数量，例如 1000

3. 点击"创建项目"
4. MetaMask 会弹出两次确认：
   - 第一次：授权合约使用您的代币
   - 第二次：创建项目的交易
5. 确认两次交易

**注意**：基础奖金会从您的账户转入奖池，玩家购买彩票后奖池会增加

### 第四步：购买彩票（玩家操作）

1. 点击"所有项目"标签页
2. 浏览可用的竞猜项目
3. 选择您看好的选项
4. 点击"购买 (100 BET)"按钮
5. MetaMask 会弹出两次确认：
   - 第一次：授权代币
   - 第二次：购买彩票
6. 确认交易

**结果**：
- 消耗 100 BET 代币
- 获得一张彩票 NFT
- 项目总奖池增加 100 BET

### 第五步：查看我的彩票

1. 点击"我的彩票"标签页
2. 查看您拥有的所有彩票
3. 每张彩票显示：
   - 彩票 ID
   - 所属项目
   - 选择的选项
   - 项目状态

### 第六步：交易彩票（挂单出售）

1. 在"我的彩票"页面
2. 选择要出售的彩票
3. 在价格输入框中输入出售价格（单位：BET）
4. 点击"挂单出售"
5. MetaMask 会弹出两次确认：
   - 第一次：授权合约转移 NFT
   - 第二次：创建订单
6. 确认交易

**提示**：只有进行中的项目的彩票可以交易

### 第七步：购买订单中的彩票

1. 点击"交易市场"标签页
2. 从下拉菜单选择项目
3. 查看订单簿，显示所有挂单信息：
   - 订单 ID
   - 彩票 ID
   - 卖家地址
   - 价格
4. 点击"购买"按钮
5. MetaMask 会弹出两次确认：
   - 第一次：授权代币支付
   - 第二次：购买交易
6. 确认交易

**结果**：
- 您支付 BET 代币给卖家
- 彩票 NFT 转移到您的账户
- 订单从订单簿移除

### 第八步：结算项目（公证人操作）

1. 在"所有项目"页面
2. 找到您创建的项目
3. 如果项目仍在进行中，会显示"结算项目"区域
4. 点击获胜选项对应的按钮
5. MetaMask 确认交易

**结果**：
- 项目状态变为"已结算"
- 显示获胜选项
- 获胜者可以领取奖励

### 第九步：领取奖励（获胜者操作）

1. 点击"我的彩票"标签页
2. 找到已结算项目中获胜的彩票
3. 点击"领取奖励"按钮
4. MetaMask 确认交易

**结果**：
- 获得奖池平分的 BET 代币
- 彩票被销毁（防止重复领取）
- 余额自动更新

**奖励计算公式**：
```
每张获胜彩票的奖励 = 总奖池 / 获胜彩票数量
```

---

## 🎯 完整测试流程示例

### 场景：NBA MVP 竞猜

#### 角色准备
- **公证人**: MetaMask 账户 A
- **玩家1**: MetaMask 账户 B
- **玩家2**: MetaMask 账户 C

#### 步骤

**1. 所有账户领取代币**
- 账户 A, B, C 分别连接钱包并领取 1000 BET

**2. 公证人创建项目**（账户 A）
- 名称: "NBA 2024赛季 MVP"
- 描述: "竞猜NBA本赛季最有价值球员"
- 选项: "詹姆斯,库里,杜兰特"
- 持续时间: 3600（1小时）
- 基础奖金: 500 BET

**3. 玩家购买彩票**
- 账户 B: 购买 2 张"詹姆斯"的彩票（消耗 200 BET）
- 账户 C: 购买 1 张"库里"的彩票（消耗 100 BET）
- 此时奖池: 500 + 200 + 100 = 800 BET

**4. 玩家交易彩票**（突发情况：詹姆斯受伤）
- 账户 B: 将一张"詹姆斯"彩票以 50 BET 挂单出售
- 账户 C: 以 50 BET 购买
- 现在账户 B 有 1 张"詹姆斯"，账户 C 有 1 张"库里" + 1 张"詹姆斯"

**5. 公证人结算项目**（账户 A）
- 选择"詹姆斯"为获胜选项

**6. 获胜者领取奖励**
- 账户 B 领取: 800 / 2 = 400 BET
- 账户 C 领取: 800 / 2 = 400 BET
- （因为詹姆斯有 2 张彩票，每张获得一半奖池）

---

## 🔧 常见问题解决

### Q1: MetaMask 没有弹出确认窗口
**解决方案**：
- 检查 MetaMask 插件是否已解锁
- 点击浏览器顶部的 MetaMask 图标，手动打开
- 确认网络切换到 Ganache Local

### Q2: 交易失败 "insufficient funds"
**解决方案**：
- 确保账户有足够的 BET 代币
- 点击"领取代币"获取更多 BET
- 确保账户有足够的 ETH（Ganache 应该默认提供）

### Q3: 合约地址未更新
**解决方案**：
```bash
cd contracts
node scripts/update-frontend-config.js
```
然后重启前端服务器

### Q4: 无法连接到 Ganache
**解决方案**：
- 确认 Ganache 正在运行
- 检查 RPC 地址是否为 http://127.0.0.1:8545
- 在 Hardhat 配置中确认端口号

### Q5: 页面显示"Project does not exist"
**解决方案**：
- 确认合约已正确部署
- 刷新页面重新加载项目列表
- 检查浏览器控制台是否有错误信息

### Q6: 订单簿不显示订单
**解决方案**：
- 确保选择了正确的项目
- 确认项目状态为"进行中"
- 检查是否有人创建了订单

---

## 💡 高级功能说明

### 智能合约架构

#### BetToken.sol (ERC20)
- 积分代币，用于系统内交易
- 支持用户领取免费代币
- 每个地址最多领取 10 次，每次 1000 BET

#### BetTicket.sol (ERC721)
- 彩票凭证，每张彩票是唯一的 NFT
- 记录项目 ID 和选项索引
- 支持查询用户拥有的所有彩票

#### BettingSystem.sol (主合约)
- 管理竞猜项目的创建和结算
- 处理彩票购买和交易
- 实现链上订单簿
- 处理奖励分配

### 订单簿机制

订单簿是完全去中心化的，存储在区块链上：
- 卖方可以以任意价格挂单
- 买方可以查看所有订单并选择购买
- 支持按价格排序（前端可扩展）
- 交易完成后订单自动失效

### 安全特性

1. **重入攻击防护**: 使用 OpenZeppelin 的 ReentrancyGuard
2. **授权检查**: 所有转账前都检查授权
3. **防止重复领取**: 彩票领取奖励后会被销毁
4. **权限控制**: 只有创建者可以结算项目

---

## 📊 合约功能列表

### BetToken 合约
- `claimTokens()` - 领取免费代币
- `getRemainingClaims(address)` - 查询剩余可领取次数
- 标准 ERC20 功能（transfer, approve, balanceOf 等）

### BetTicket 合约
- `mintTicket(address, uint256, uint256)` - 铸造彩票（仅系统）
- `getTicketInfo(uint256)` - 查询彩票信息
- `getTicketsOfOwner(address)` - 查询用户彩票列表
- 标准 ERC721 功能

### BettingSystem 合约
- `createProject(...)` - 创建竞猜项目
- `purchaseTicket(uint256, uint256)` - 购买彩票
- `createSellOrder(uint256, uint256)` - 创建出售订单
- `cancelOrder(uint256)` - 取消订单
- `buyTicketFromOrder(uint256)` - 从订单购买彩票
- `settleProject(uint256, uint256)` - 结算项目
- `claimReward(uint256)` - 领取奖励
- `getProjectInfo(uint256)` - 查询项目信息
- `getProjectOrders(uint256)` - 查询项目订单簿

---

## 🎨 界面说明

### 主界面分为 4 个标签页

1. **所有项目**: 
   - 浏览所有竞猜项目
   - 查看项目详情和统计
   - 购买彩票
   - 结算项目（公证人）

2. **创建项目**: 
   - 公证人创建新的竞猜项目
   - 设置项目参数和基础奖金

3. **我的彩票**: 
   - 查看拥有的所有彩票
   - 挂单出售彩票
   - 领取获胜奖励

4. **交易市场**: 
   - 查看订单簿
   - 购买其他玩家挂单的彩票
   - 按项目筛选订单

---

## 📝 注意事项

1. **代币授权**: 每次使用代币前都需要授权，这是 ERC20 标准的安全机制
2. **Gas 费用**: 在 Ganache 测试网络上，所有交易都使用测试 ETH，无实际成本
3. **时间设置**: 创建项目时的持续时间单位是秒
4. **彩票价格**: 固定为 100 BET，在合约中定义为常量
5. **账户切换**: 切换 MetaMask 账户后，页面会自动更新余额和信息

---

## 🔄 重新部署

如果需要重新部署合约：

```bash
# 1. 重启 Ganache（这会清空所有数据）
# 2. 重新部署
cd contracts
npx hardhat run scripts/deploy.ts --network ganache

# 3. 更新前端配置
node scripts/update-frontend-config.js

# 4. 重启前端（Ctrl+C 停止，然后重新 npm start）
```

---

## 📞 技术支持

### 项目结构
```
ZJU-blockchain-course-2025/
├── contracts/
│   ├── contracts/
│   │   ├── BetToken.sol          # ERC20 代币合约
│   │   ├── BetTicket.sol         # ERC721 彩票合约
│   │   └── BettingSystem.sol     # 主系统合约
│   ├── scripts/
│   │   ├── deploy.ts             # 部署脚本
│   │   └── update-frontend-config.js  # 配置更新脚本
│   └── hardhat.config.ts         # Hardhat 配置
├── frontend/
│   └── src/
│       ├── contracts/
│       │   ├── addresses.ts      # 合约地址配置
│       │   └── abis.ts          # 合约 ABI
│       ├── App.tsx              # 主应用组件
│       └── App.css              # 样式文件
└── 使用说明文档.md              # 本文档
```

### 开发工具
- **Hardhat**: 以太坊开发环境
- **OpenZeppelin**: 安全的智能合约库
- **React**: 前端框架
- **ethers.js**: 以太坊 JavaScript 库
- **MetaMask**: 以太坊钱包

---

## ✨ 功能亮点

✅ **完整的 ERC20 积分系统**
- 免费领取机制
- 可用于购买彩票和交易

✅ **ERC721 彩票凭证**
- 每张彩票都是唯一的 NFT
- 可自由转让和交易

✅ **灵活的竞猜项目**
- 支持多个选项
- 公证人设置基础奖金
- 购买后奖池累加

✅ **去中心化订单簿**
- 完全链上订单管理
- 实时更新
- 透明的价格发现

✅ **公平的奖励分配**
- 获胜者平分奖池
- 自动计算每张彩票奖励
- 防止重复领取

✅ **美观的用户界面**
- 响应式设计
- 清晰的操作流程
- 实时反馈

✅ **完善的安全机制**
- 重入攻击防护
- 授权检查
- 权限控制

---

## 🎉 总结

这是一个功能完整、安全可靠的去中心化彩票系统。通过本文档，您应该能够：

1. ✅ 成功部署所有智能合约
2. ✅ 配置并运行前端应用
3. ✅ 理解所有功能的使用方法
4. ✅ 进行完整的测试流程
5. ✅ 解决常见问题

如有任何问题，请检查：
- Ganache 是否正在运行
- MetaMask 是否正确配置
- 合约是否成功部署
- 控制台是否有错误信息

祝您使用愉快！🎰

